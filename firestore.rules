rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId));
    }

    function userHasRole(userId, role) {
      let userData = getUserData(userId);
      return userData.data.roles.hasAny([role]);
    }
    
    function userIsInOrg(userId, orgId) {
      let userData = getUserData(userId);
      return userData.data.organizationId == orgId;
    }

    function isDoctorInOrg(orgId) {
      return isSignedIn() && userHasRole(request.auth.uid, 'doctor') && userIsInOrg(request.auth.uid, orgId);
    }
    
    function isPatientUser(patientId) {
       let patientDoc = get(/databases/$(database)/documents/patients/$(patientId));
       return isOwner(patientDoc.data.userId);
    }

    // /users/{userId}
    match /users/{userId} {
      // Anyone can create their own user document.
      allow create: if (isOwner(userId) && request.resource.data.email == request.auth.token.email);
      // Only the owner can update their own profile.
      allow update: if isOwner(userId);
      // Any authenticated user can read any user's profile (for searching/linking).
      allow get, list: if isSignedIn();
      // Only the owner can delete their account.
      allow delete: if isOwner(userId);
    }

    // /patients/{patientId}
    match /patients/{patientId} {
      // Doctors can create new patient records.
      allow create: if (isDoctorInOrg(request.resource.data.organizationId));
      // Doctors in the org and the patient themselves can view the record.
      allow get: if (isDoctorInOrg(resource.data.organizationId) || isPatientUser(patientId));
      // Doctors in the org can list patients.
      allow list: if (isDoctorInOrg(request.query.organizationId));
      // Doctors can update patient records.
      allow update: if (isDoctorInOrg(resource.data.organizationId));
      // Doctors can delete patient records.
      allow delete: if (isDoctorInOrg(resource.data.organizationId));

      // Subcollections for a patient
      
      // /patients/{patientId}/medical_records/{recordId}
      match /medical_records/{recordId} {
        // Doctors in the org can create medical records for a patient.
        allow create: if (isDoctorInOrg(request.resource.data.organizationId));
        // Doctors in the org and the patient can read medical records.
        allow get, list: if (isDoctorInOrg(get(/databases/$(database)/documents/patients/$(patientId)).data.organizationId) || isPatientUser(patientId));
        // Doctors can update records.
        allow update: if (isDoctorInOrg(resource.data.organizationId));
        // Doctors can delete records.
        allow delete: if (isDoctorInOrg(resource.data.organizationId));
      }

      // /patients/{patientId}/record_files/{fileId}
      match /record_files/{fileId} {
        // Patients can upload their own files.
        allow create: if (isPatientUser(patientId));
        // Patients can read their own files. Doctors can read files of patients in their org.
        allow get, list: if (isPatientUser(patientId) || isDoctorInOrg(get(/databases/$(database)/documents/patients/$(patientId)).data.organizationId));
        // Only patients can delete their own files.
        allow delete: if (isPatientUser(patientId));
      }

      // /patients/{patientId}/vitals/{vitalId}
      match /vitals/{vitalId} {
        // Patients can add their own vitals.
        allow create: if (isPatientUser(patientId));
         // Patients and doctors in the org can read vitals.
        allow get, list: if (isPatientUser(patientId) || isDoctorInOrg(get(/databases/$(database)/documents/patients/$(patientId)).data.organizationId));
        // Vitals are immutable.
        allow update, delete: if false;
      }
      
      // /patients/{patientId}/privacy_log/{logId}
      match /privacy_log/{logId} {
        // System/backend function would create these. Allow create for doctors for now.
        allow create: if isDoctorInOrg(request.resource.data.organizationId);
        // Only the patient can view their own privacy log.
        allow get, list: if isPatientUser(patientId);
        allow update, delete: if false;
      }
    }
  }
}
